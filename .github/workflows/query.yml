name: Run Query Engine

on:
  workflow_dispatch:
    inputs:
      text:
        description: "User query text"
        required: true
        type: string

jobs:
  query:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies (if any)
        run: |
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            echo "No requirements.txt found, skipping pip install"
          fi

      - name: Run query engine (raw output)
        run: |
          echo "[query.yml] Running query_v2.py"
          python scripts/query_v2.py "${{ inputs.text }}"

      - name: Convert querycorpora output to strict JSON
        run: |
          echo "[query.yml] Converting querycorpora output"
          python scripts/convert_querycorpora_to_json.py

          echo "[query.yml] Converted JSON content:"
          LATEST=$(ls -1 querycorpora/*.converted.json | tail -n 1)
          echo "---- $LATEST ----"
          cat "$LATEST"
          echo "-----------------"

      - name: Run interpreter
        run: |
          echo "[query.yml] Running interpreter.py"
          python scripts/interpreter.py

      - name: Render HTML output
        run: |
          echo "[query.yml] Rendering HTML"
          python scripts/render_html.py

      - name: Commit updated HTML
        run: |
          echo "[query.yml] Committing web/index.html"

          git config user.name "github-actions"
          git config user.email "actions@github.com"

          git fetch origin
          git reset --hard origin/main

          git add web/index.html
          git commit -m "Update query result HTML" || echo "No changes to commit"
          git push
